# encoding: shift-jis

import os
import unittest

import win32con

import util_win.keycode as keycode

import hotkey_loader

class HotkeyEntryTest(unittest.TestCase):
    def setUp(self):
        pass

    def tearDown(self):
        pass

    def assertEntry(self, line, exp_name, exp_mod, exp_key):
        hotkey_entry = hotkey_loader.HotkeyEntry(line)
        self.assertEqual(hotkey_entry._name, exp_name)
        self.assertEqual(hotkey_entry._modifier, exp_mod)
        self.assertEqual(hotkey_entry._keycode, exp_key)

    def test_HotkeyEntry(self):
        """
        正常系は簡単にテスト. 余力あらば観点を追加するといい.
        """
        testname = "hoge"

        # 各修飾キーを正しく変換できる
        self.assertEntry(
            testname + "," + "a, k",
            testname, win32con.MOD_ALT, keycode.K
        )
        self.assertEntry(
            testname + "," + "c, insert",
            testname, win32con.MOD_CONTROL, keycode.INSERT
        )
        self.assertEntry(
            testname + "," + "s, enter",
            testname, win32con.MOD_SHIFT, keycode.ENTER
        )
        self.assertEntry(
            testname + "," + "w, esc",
            testname, win32con.MOD_WIN, keycode.ESC
        )

        # 修飾キーの組み合わせを正しく変換できる
        # ついでに, 大文字小文字問わないことと, 空白有っても良いことも確認.
        self.assertEntry(
            testname + "," + "cs, k", testname,
            win32con.MOD_CONTROL|win32con.MOD_SHIFT,
            keycode.K
        )
        self.assertEntry(
            testname + "," + "   \t cWa   \t , k \t\t  ", testname,
            win32con.MOD_CONTROL|win32con.MOD_WIN|win32con.MOD_ALT,
            keycode.K
        )
        self.assertEntry(
            testname + "," + "aSCw, k", testname,
            win32con.MOD_SHIFT|win32con.MOD_CONTROL| \
            win32con.MOD_WIN|win32con.MOD_ALT,
            keycode.K
        )

        # 異常系
        try:
            # 修飾キーの指定が無いとエラー
            hotkey_loader.HotkeyEntry("name")
            self.assertTrue(False)
        except RuntimeError:
            pass
        try:
            # 文字キーの指定が無いとエラー
            hotkey_loader.HotkeyEntry("name,as")
            self.assertTrue(False)
        except RuntimeError:
            pass
        try:
            # 空文字列を与えるとエラー
            hotkey_loader.HotkeyEntry("")
            self.assertTrue(False)
        except RuntimeError:
            pass
        try:
            # 修飾キーが無効だとエラー
            hotkey_loader.HotkeyEntry("name,qqq,k")
            self.assertTrue(False)
        except RuntimeError:
            pass
        try:
            # 文字キーが無効だとエラー
            hotkey_loader.HotkeyEntry("name,sc,invalidname")
            self.assertTrue(False)
        except RuntimeError:
            pass

    def test_IniLoader(self):
        """
        マジックナンバーは,
        テスト用設定ファイルの内容を決め打ちしている分.
        """
        loader = hotkey_loader.IniLoader()
        content = loader.read_all()

        def assert_entry(hotkey_entry, exp_name, exp_mod, exp_key):
            self.assertEqual(hotkey_entry._name, exp_name)
            self.assertEqual(hotkey_entry._modifier, exp_mod)
            self.assertEqual(hotkey_entry._keycode, exp_key)

        # 設定件数の確認
        self.assertEqual(5, len(content))

        # 各設定の中身を確認,
        assert_entry(
            content[0],
            "correct_1_modifier",win32con.MOD_SHIFT,keycode.A
        )
        assert_entry(
            content[1],
            "correct_2_modifier",
            win32con.MOD_CONTROL|win32con.MOD_ALT,
            keycode.A
        )
        assert_entry(
            content[2],
            "correct_3_modifier",
            win32con.MOD_WIN|win32con.MOD_SHIFT|win32con.MOD_CONTROL,
            keycode.A
        )
        assert_entry(
            content[3],
            "correct_4_modifier",
            win32con.MOD_ALT|win32con.MOD_WIN| \
            win32con.MOD_SHIFT|win32con.MOD_CONTROL,
            keycode.A
        )
        assert_entry(
            content[4], "correct_many_spaces",win32con.MOD_ALT,keycode.A
        )

if __name__ == "__main__":
    unittest.main()
